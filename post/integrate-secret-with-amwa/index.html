<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://sanchitdilipjain.github.io/js/theme-mode.js></script><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/frameworks.min.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/github.min.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/github-style.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/light.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/dark.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/syntax.css><title>Integrate AWS Secret Manager with AWS Managed workflow for Apache Airflow üîç - Sanchit's blog</title>
<link rel=icon type=image/x-icon href=https://sanchitdilipjain.github.io/images/github.png><meta name=theme-color content="#1e2327"><meta name=description content="Never become so much of an expert that you stop gaining expertise. View life as a continuous learning experience."><meta name=robots content="noodp"><link rel=canonical href=https://sanchitdilipjain.github.io/post/integrate-secret-with-amwa/><meta name=twitter:card content="summary"><meta name=twitter:title content="Sanchit's Blog"><meta name=twitter:description content="Integrate AWS Secret Manager with AWS Managed workflow for Apache Airflow Overview
What is AWS Managed Apache Airflow?
AWS Managed Apache Airflow (MWAA) is a managed service that makes it easier to run and manage workflows built with Apache Airflow on AWS. Apache Airflow is an open-source tool used to programmatically author, schedule, and monitor workflows. With MWAA, AWS takes care of the operational aspects such as scaling, patching, and availability, allowing you to focus on building and managing your workflows."><meta name=twitter:site content="https://sanchitdilipjain.github.io/"><meta name=twitter:creator content="Sanchit Jain"><meta name=twitter:image content="https://sanchitdilipjain.github.io//images/preview.png"><meta property="og:type" content="article"><meta property="og:title" content="Sanchit's Blog"><meta property="og:description" content="Never become so much of an expert that you stop gaining expertise. View life as a continuous learning experience."><meta property="og:url" content="https://sanchitdilipjain.github.io/"><meta property="og:site_name" content="Sanchit's Blog"><meta property="og:image" content="https://sanchitdilipjain.github.io//images/preview.png"><meta property="og:image:type" content="image/png"><meta name=thumbnail content="https://sanchitdilipjain.github.io//images/preview.png"><meta name=author content="Sanchit Jain"><meta property="article:published_time" content="2024-06-18 12:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-63LNCKX5VR"></script><script>if(navigator.doNotTrack!=="1"){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-63LNCKX5VR")}</script></head><body><style>.height-limitation{max-height:300px;overflow-y:scroll}.loader{border:4px solid #f3f3f3;border-bottom:4px solid var(--color-fg-muted);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://sanchitdilipjain.github.io/><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=UTF-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://sanchitdilipjain.github.io/><div class="js-jump-to-suggestions-container jump-to-suggestions overflow-hidden position-absolute"><div id=search-progress class="d-none color-bg-primary no-underline p-2" role=progress aria-selected=false><div class=loader></div></div><ul id=jump-to-results role=listbox class="Box border-0 p-0 m-0 js-navigation-container jump-to-suggestions-results-container js-jump-to-suggestions-results-container js-active-navigation-container height-limitation"></ul></div></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://sanchitdilipjain.github.io/><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://sanchitdilipjain.github.io/><img class=avatar-user src=https://sanchitdilipjain.github.io/images/avatar.png width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://sanchitdilipjain.github.io/>Sanchit Dilip Jain</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://sanchitdilipjain.github.io/post/integrate-secret-with-amwa/>Integrate AWS Secret Manager with AWS Managed workflow for Apache Airflow üîç</a></strong></h1><div class="note m-0">Created <relative-time datetime="Tue, 18 Jun 2024 12:00:00 +0000" class=no-wrap>Tue, 18 Jun 2024 12:00:00 +0000</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Sun, 07 Jul 2024 00:15:26 +0000" class=no-wrap>Sun, 07 Jul 2024 00:15:26 +0000</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>715 Words
<span class=file-info-divider></span>
3 min</div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><h2 id=integrate-aws-secret-manager-with-aws-managed-workflow-for-apache-airflow>Integrate AWS Secret Manager with AWS Managed workflow for Apache Airflow</h2><p><strong>Overview</strong></p><ol><li><p>What is AWS Managed Apache Airflow?</p><ul><li>AWS Managed Apache Airflow (MWAA) is a managed service that makes it easier to run and manage workflows built with Apache Airflow on AWS. Apache Airflow is an open-source tool used to programmatically author, schedule, and monitor workflows.</li><li>With MWAA, AWS takes care of the operational aspects such as scaling, patching, and availability, allowing you to focus on building and managing your workflows.</li></ul></li><li><p>What is AWS Secrets Manager?</p><ul><li>AWS Secrets Manager is a service that helps you protect access to your applications, services, and IT resources without the upfront cost and complexity of managing your own hardware security modules (HSMs) or infrastructure.</li><li>Secrets Manager enables you to rotate, manage, and retrieve database credentials, API keys, and other secrets throughout their lifecycle. Users and applications retrieve secrets with a call to the Secrets Manager API, eliminating the need to hard-code sensitive information in plaintext.</li></ul></li><li><p>Importance of Securing Credentials:</p><ul><li>Securing credentials is critical for the following reasons:<ul><li>Prevent Unauthorized Access</li><li>Maintain Data Integrity</li><li>Compliance and Auditing</li><li>Reduce Risk of Breaches</li></ul></li><li>By integrating AWS Secrets Manager with AWS Managed Apache Airflow, you can securely manage and retrieve secrets, ensuring that your workflows operate securely and efficiently.</li></ul></li></ol><p><strong>Demo</strong></p><ul><li><p>Managing secrets securely is a crucial aspect of deploying workflows on AWS Managed Apache Airflow. This blog will walk you through the steps required to securely insert secrets at the start of your workflows using AWS Secrets Manager and AWS IAM.</p><ul><li><p><strong>Prerequisites</strong></p><ul><li><p>AWS Account: Ensure you have an AWS account with the necessary permissions.</p></li><li><p>AWS CLI: Install and configure the AWS CLI on your local machine.</p></li><li><p>Apache Airflow Environment: An existing AWS Managed Apache Airflow environment.</p></li></ul></li><li><p><strong>Step 1:</strong> Create a Secret in AWS Secrets Manager</p><ul><li><p>Navigate to AWS Secrets Manager in the AWS Management Console.</p></li><li><p>Click on &ldquo;Store a new secret&rdquo;.</p></li><li><p>Select the type of secret you want to store (e.g., &ldquo;Other type of secrets&rdquo;).</p></li><li><p>Enter the key-value pairs for your secret.</p></li><li><p>Name your secret and add an optional description.</p></li><li><p>Configure rotation settings if needed (optional).</p></li><li><p>Click &ldquo;Next&rdquo; and review your secret before clicking &ldquo;Store&rdquo;.</p></li></ul></li><li><p><strong>Step 2:</strong> To allow your Airflow environment to access the secrets, you need to create an IAM role and attach a policy.</p><ul><li><p>Create a new IAM policy with the following JSON, replacing YOUR_SECRET_ARN with the ARN of your secret:</p><pre tabindex=0><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;secretsmanager:GetSecretValue&#34;
            ],
            &#34;Resource&#34;: &#34;YOUR_SECRET_ARN&#34;
        }
    ]
}
</code></pre></li><li><p>Create a new IAM role for your Airflow environment and attach the above policy.</p></li><li><p>Attach the IAM role to your Amazon MWAA environment:</p></li><li><p>Navigate to the Amazon MWAA environment in the AWS Management Console.</p></li><li><p>Under the &ldquo;Security configuration&rdquo; section, attach the newly created IAM role.</p></li></ul></li><li><p><strong>Step 3:</strong> Update Airflow DAG to Retrieve Secrets</p><ul><li><p>Modify your Airflow DAG to retrieve the secret from AWS Secrets Manager at the start of the workflow.</p></li><li><p>Install the required Python package:</p><pre tabindex=0><code>pip install boto3
</code></pre></li><li><p>Update your DAG file to include the following script for fetching secrets:</p><pre tabindex=0><code>from airflow import DAG
from airflow.operators.python_operator import PythonOperator
from airflow.utils.dates import days_ago
import boto3
import base64
from botocore.exceptions import ClientError

def get_secret():
    secret_name = &#34;YOUR_SECRET_NAME&#34;
    region_name = &#34;YOUR_AWS_REGION&#34;

    # Create a Secrets Manager client
    session = boto3.session.Session()
    client = session.client(
        service_name=&#39;secretsmanager&#39;,
        region_name=region_name
    )

    try:
        get_secret_value_response = client.get_secret_value(
            SecretId=secret_name
        )
    except ClientError as e:
        raise e

    # Decrypts secret using the associated KMS key.
    if &#39;SecretString&#39; in get_secret_value_response:
        secret = get_secret_value_response[&#39;SecretString&#39;]
    else:
        secret = base64.b64decode(get_secret_value_response[&#39;SecretBinary&#39;])

    return secret

default_args = {
    &#39;owner&#39;: &#39;airflow&#39;,
    &#39;start_date&#39;: days_ago(1),
}

dag = DAG(
    &#39;retrieve_secret_dag&#39;,
    default_args=default_args,
    description=&#39;A simple DAG to retrieve secrets from AWS Secrets Manager&#39;,
    schedule_interval=None,
)

retrieve_secret = PythonOperator(
    task_id=&#39;retrieve_secret&#39;,
    python_callable=get_secret,
    dag=dag,
)

retrieve_secret
</code></pre></li></ul></li><li><p><strong>Step 4:</strong> Deploy and Run Your DAG</p><ul><li>Upload the DAG file to your S3 bucket linked to the Amazon MWAA environment.</li><li>Navigate to the Airflow UI and trigger the DAG.</li><li>Verify the logs to ensure the secret was retrieved successfully.</li></ul></li></ul></li></ul><p><strong>Resources</strong></p><ul><li>By following these steps, you can securely manage and access secrets in your AWS Managed Apache Airflow environment using AWS Secrets Manager and IAM roles. This setup ensures that your sensitive data remains secure and is accessible only to authorized workflows.</li><li>For more detailed information, you can refer to the <a href=https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html>AWS Secrets Manager</a> documentation and the <a href=https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html>AWS Managed Apache Airflow documentation</a>.</li></ul></article></div></div></div></div></div><div class=pagination-nav><div class="pagination-button next-post"><div>¬´&nbsp;</div><a class="pagination-link link-reverse" href=https://sanchitdilipjain.github.io/post/integrate-jfrog-with-amwa/>Integrate Jfrog Artifactory with AWS Managed...</a></div><div class="pagination-button previous-post"><a class="pagination-link link-reverse" href=https://sanchitdilipjain.github.io/post/amazon-opensearch-best-practice/>Tips & Tricks for Optimizing Amazon OpenSearch:...&nbsp;</a><div>¬ª</div></div></div></div></main></div><script type=application/javascript src=https://sanchitdilipjain.github.io/js/toc.js></script><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://sanchitdilipjain.github.io/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0"></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://sanchitdilipjain.github.io/js/github-style.js></script><script src=https://sanchitdilipjain.github.io/js/mark.es6.min.js></script></html>