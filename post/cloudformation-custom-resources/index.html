<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://sanchitdilipjain.github.io/js/theme-mode.js></script><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/frameworks.min.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/github.min.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/github-style.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/light.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/dark.css><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/syntax.css><title>Deep-dive of custom resources in AWS Cloudformation 📌 - Sanchit's blog</title>
<link rel=icon type=image/x-icon href=https://sanchitdilipjain.github.io/images/github.png><meta name=theme-color content="#1e2327"><meta name=description content="Never become so much of an expert that you stop gaining expertise. View life as a continuous learning experience."><meta name=robots content="noodp"><link rel=canonical href=https://sanchitdilipjain.github.io/post/cloudformation-custom-resources/><meta name=twitter:card content="summary"><meta name=twitter:title content="Sanchit's Blog"><meta name=twitter:description content="Cloudformation Custom resources What is AWS Cloudformation?
AWS CloudFormation offers an easy way to deploy a collection of related AWS and third-party resources, provision them faster, and manage them throughout their lifecycles, by treating infrastructure as code.
A CloudFormation template contains information for the desired resources and their dependencies so we can launch and configure them together as a stack. We can use templates to create, update, and delete an entire stack as a single unit, instead of managing resources individually."><meta name=twitter:site content="https://sanchitdilipjain.github.io"><meta name=twitter:creator content="Sanchit Jain"><meta name=twitter:image content="https://sanchitdilipjain.github.io/images/preview.png"><meta property="og:type" content="article"><meta property="og:title" content="Sanchit's Blog"><meta property="og:description" content="Never become so much of an expert that you stop gaining expertise. View life as a continuous learning experience."><meta property="og:url" content="https://sanchitdilipjain.github.io"><meta property="og:site_name" content="Sanchit's Blog"><meta property="og:image" content="https://sanchitdilipjain.github.io/images/preview.png"><meta property="og:image:type" content="image/png"><meta name=thumbnail content="https://sanchitdilipjain.github.io/images/preview.png"><meta name=author content="Sanchit Jain"><meta property="article:published_time" content="2021-03-11 12:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-63LNCKX5VR"></script><script>if(navigator.doNotTrack!=="1"){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-63LNCKX5VR")}</script></head><body><style>.height-limitation{max-height:300px;overflow-y:scroll}.loader{border:4px solid #f3f3f3;border-bottom:4px solid var(--color-fg-muted);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://sanchitdilipjain.github.io><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=UTF-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://sanchitdilipjain.github.io><div class="js-jump-to-suggestions-container jump-to-suggestions overflow-hidden position-absolute"><div id=search-progress class="d-none color-bg-primary no-underline p-2" role=progress aria-selected=false><div class=loader></div></div><ul id=jump-to-results role=listbox class="Box border-0 p-0 m-0 js-navigation-container jump-to-suggestions-results-container js-jump-to-suggestions-results-container js-active-navigation-container height-limitation"></ul></div></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://sanchitdilipjain.github.io><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://sanchitdilipjain.github.io><img class=avatar-user src=https://sanchitdilipjain.github.io/images/avatar.png width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://sanchitdilipjain.github.io>Sanchit Dilip Jain</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://sanchitdilipjain.github.io/post/cloudformation-custom-resources/>Deep-dive of custom resources in AWS Cloudformation 📌</a></strong></h1><div class="note m-0">Created <relative-time datetime="Thu, 11 Mar 2021 12:00:00 +0000" class=no-wrap>Thu, 11 Mar 2021 12:00:00 +0000</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Sun, 07 Jan 2024 14:14:37 +0000" class=no-wrap>Sun, 07 Jan 2024 14:14:37 +0000</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>748 Words
<span class=file-info-divider></span>
3 min</div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><h2 id=cloudformation-custom-resources>Cloudformation Custom resources</h2><ol><li><p>What is AWS Cloudformation?</p><ul><li><p>AWS CloudFormation offers an easy way to deploy a collection of related AWS and third-party resources, provision them faster, and manage them throughout their lifecycles, by treating infrastructure as code.</p></li><li><p>A CloudFormation template contains information for the desired resources and their dependencies so we can launch and configure them together as a stack. We can use templates to create, update, and delete an entire stack as a single unit, instead of managing resources individually. We can also manage and provision stacks across multiple AWS accounts and AWS Regions.</p></li><li><p>However, Cloudformation fails at certain places, such as executing a lambda via deploying the stacks or needing to know the CIDR Block for the VPC from a given VPC ID. There we can leverage AWS CloudFormation Custom Resource to overcome these loopholes</p></li></ul></li><li><p>What are CloudFormation Custom Resources?</p><ul><li><p>A custom resource is a custom type powered by a Lambda function to execute a task that CloudFormation cannot do, for example, retrieving an AMI ID or the CIDR block for a VPC.</p></li><li><p>Custom resources have a “request type” included with the request, allowing the custom resource to create, update and delete whatever it is doing. Outside to just normal lookup, there are more capabilities an AWS CloudFormation Custom Resource can provide</p></li></ul></li><li><p>How Does the Custom Resource Work?</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image1.png alt=image1></p><ul><li><p>Let&rsquo;s assume we are deploying the below custom resource as part of the CloudFormation template.</p><pre tabindex=0><code class=language-MyResource: data-lang=MyResource:>Type: Custom::Test
Properties:
    ServiceToken: LambdaARN
    Name: “Value”
    List: [&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;]
</code></pre></li><li><p>When CloudFormation runs the above input, it uses the ServiceToken to lookup the Lambda function it is aspected to invoke and sends the parameters to that function.</p><pre tabindex=0><code>      &#34;RequestType&#34; : &#34;Create&#34;,
      &#34;ResponseURL&#34; : “foo”,
      &#34;StackId&#34; : ”bar”,
      &#34;RequestId&#34; : &#34;unique id”,
      &#34;ResourceType&#34; : &#34;Custom::Test&#34;,
      &#34;LogicalResourceId&#34; : &#34;MyResource&#34;,
      &#34;ResourceProperties&#34; :
       {
         &#34;Name&#34; : &#34;Value&#34;, 
         &#34;List&#34; : [ &#34;1&#34;, &#34;2&#34;, &#34;3&#34; ]
       }
     }
</code></pre></li><li><p>The request also contains a pre-signed URL leveraged by the Lambda function to return the response. All of the interaction between the custom resource and CloudFormation is conducted via this pre-signed URL. If the custom resource doesn’t return the information to the pre-signed URL, the CloudFormation will not complete. If we don&rsquo;t specify a timeout for the stack creation, the stack will hang for hours.</p><pre tabindex=0><code>      &#34;RequestType&#34;: &#34;Create&#34;, 
      &#34;ServiceToken&#34;: LambdaARN, 
      &#34;ResponseURL&#34;: &#34;foo&#34;,
      &#34;StackId&#34;: &#34;bar&#34;, 
      &#34;RequestId&#34;: &#34;unique id&#34;, 
      &#34;LogicalResourceId&#34;: &#34;MyResource&#34;, 
      &#34;ResourceType’: &#34;Custom::Test&#34;, 
      &#34;ResourceProperties&#34;:{
        &#34;ServiceToken&#34;: LambdaARN, 
        &#34;Name&#34; : &#34;Value&#34;, 
        &#34;List&#34; : [ &#34;1&#34;, &#34;2&#34;, &#34;3&#34; ]
        }
      }
</code></pre></li><li><p>In this sample request, there are several entries:</p><ul><li><p>RequestType: It holds either create, update or delete. And used to assist the custom resource to decide what to do</p></li><li><p>ServiceToken: service token holds Custom resource ARN where CloudFormation needs to send the requests</p></li><li><p>ResponseURL: This is the pre-signed URL where the response must be sent back to the CloudFormation.</p></li><li><p>StackId: stack ID contains the custom resource request.</p></li><li><p>RequestId: AWS provided an unique request ID.</p></li><li><p>LogicalResourceId: name of the logical resource as it appears in the stack.</p></li><li><p>ResourceType: name of the resource as mentioned in the stack.</p></li><li><p>ResourceProperties: parameters that are provided to the function.</p></li></ul></li><li><p>After the custom resource function executes, it returns the following response to CloudFormation using the pre-signed URL provided in the Request data.</p><pre tabindex=0><code>   &#34;Status&#34; : &#34;SUCCESS&#34;,
   &#34;PhysicalResourceId&#34; : “baz”,
    &#34;StackId&#34; : “bar”,
    &#34;RequestId&#34; : &#34;unique id”,
    &#34;LogicalResourceId&#34; : &#34;MyResource&#34;
  } 
</code></pre></li><li><p>Next, CloudFormation continues the execution with the rest of the stack deployment operations</p></li></ul></li><li><p>Demo</p><ul><li><p>In this demo, we will leverage Cloudformation custom resource to copy data from one S3 bucket to other S3 bucket, and post successful copy the cloudformation stack will be completed</p></li><li><p>The following diagram shows the architectural components of the solution:</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image2.png alt=image2></p></li><li><p><a href=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/custom-resource-template.yaml>Link to Cloudformation template</a></p></li><li><p>Steps to deploy Cloudformation</p><ol><li><p>Open the AWS CloudFormation console at link</p></li><li><p>Choose Create Stack.</p></li><li><p>In the Template section, choose to Upload a template file, and then choose a file under the upload section</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image3.png alt=image3></p></li><li><p>Choose Next.</p></li><li><p>In the Stack name field, type custom-resource-tutorial, and under the Parameters section, provide the following parameter, and then choose Next.</p><ul><li><p>DestinationBucket</p></li><li><p>SourceBucketName</p></li><li><p>SourceObjects</p></li><li><p>SourceS3KeyPrefix</p></li></ul><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image4.png alt=image4></p></li><li><p>For this walkthrough, we will preserve all advanced settings as a default state, so choose Next.</p></li><li><p>Ensure that the stack name and template URL are correct, and then choose Create to.</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image5.png alt=image5></p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image6.png alt=image6></p></li><li><p>If the custom resource is executed successfully then the Cloudformation stack will be in Create Complete status, if due to some reason the custom resources execution failed then Cloudformation will be stuck for hours if the timeout is not mentioned or will be in Failed status once the timeout is over.</p><ul><li><p>Cloudformation in-progress state</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image7.png alt=image7></p></li><li><p>Successful State</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image8.png alt=image8></p></li><li><p>Failed State</p><p><img src=https://sanchitdilipjain.github.io/images/cloudformation-custom-resources/image9.png alt=image9></p></li></ul></li></ol></li></ul></li></ol></article></div></div></div></div></div><div class=pagination-nav><div class="pagination-button next-post"><div>«&nbsp;</div><a class="pagination-link link-reverse" href=https://sanchitdilipjain.github.io/post/overview-of-aws-parameter-store/>What is AWS Parameter Store? 🔑</a></div><div class="pagination-button previous-post"><a class="pagination-link link-reverse" href=https://sanchitdilipjain.github.io/post/aws-application-discovery-service/>Exploring AWS Application Discovery Service 🔍&nbsp;</a><div>»</div></div></div></div></main></div><script type=application/javascript src=https://sanchitdilipjain.github.io/js/toc.js></script><link rel=stylesheet href=https://sanchitdilipjain.github.io/css/toc.css><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://sanchitdilipjain.github.io><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0"></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://sanchitdilipjain.github.io/js/github-style.js></script><script src=https://sanchitdilipjain.github.io/js/mark.es6.min.js></script></html>